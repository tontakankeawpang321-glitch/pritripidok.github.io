<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠ - ‡∏â‡∏ö‡∏±‡∏ö‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@300;500;700&family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #fff7ed; /* ‡∏™‡πâ‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÜ ‡∏Ñ‡∏£‡∏µ‡∏°‡πÜ */
            background-image: radial-gradient(#fed7aa 1px, transparent 1px);
            background-size: 20px 20px;
        }
        h1, h2, h3, .cute-font {
            font-family: 'Mali', cursive;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* For horizontal scroll */
        }
        ::-webkit-scrollbar-track {
            background: #fff7ed; 
        }
        ::-webkit-scrollbar-thumb {
            background: #fdba74; 
            border-radius: 10px;
        }

        /* Animations */
        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .modal-content {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(234, 88, 12, 0.15);
        }
        /* Loading Spinner */
        .loader {
            border: 4px solid #fff7ed;
            border-top: 4px solid #f97316;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Hide scrollbar for category menu on mobile but keep functionality */
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* --- Chatbot Styles --- */
        #chatbot-window {
            z-index: 100;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            pointer-events: none;
        }
        #chatbot-window.active {
            transform: translateY(0) scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        .chat-bubble-ai::before {
            content: ''; position: absolute; bottom: 0; left: -8px; width: 15px; height: 15px;
            background: white; clip-path: polygon(100% 0, 100% 100%, 0 100%);
        }
        .chat-bubble-user::before {
            content: ''; position: absolute; bottom: 0; right: -8px; width: 15px; height: 15px;
            background: #f97316; clip-path: polygon(0 0, 0% 100%, 100% 100%);
        }
        .thinking-dot { animation: thinking 1.4s infinite ease-in-out; }
        @keyframes thinking { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="text-gray-700 min-h-screen flex flex-col">

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-40 shadow-sm border-b border-orange-100 h-[72px]">
        <div class="max-w-6xl mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-3 h-full">
            <div class="flex items-center gap-2 md:gap-3 w-full md:w-auto justify-center md:justify-start">
                <div class="bg-orange-100 p-2 rounded-full text-orange-500">
                    <i data-lucide="hand" class="w-6 h-6 md:w-8 md:h-8"></i>
                </div>
                <h1 class="text-xl md:text-3xl font-bold text-orange-600 cute-font whitespace-nowrap">‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠‡∏´‡∏£‡∏£‡∏©‡∏≤</h1>
            </div>
            
            <div class="relative w-full md:w-96 hidden md:block">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-lucide="search" class="w-5 h-5 text-orange-300"></i>
                </div>
                <input type="text" id="searchInputDesktop" 
                    class="block w-full pl-10 pr-3 py-2 border-2 border-orange-100 rounded-full leading-5 bg-white placeholder-orange-200 focus:outline-none focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all duration-300 cute-font" 
                    placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå... (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å ‡πÑ‡∏Å‡πà)">
            </div>
        </div>
    </header>

    <div class="md:hidden px-4 py-3 bg-white/50 backdrop-blur-sm border-b border-orange-50">
        <div class="relative w-full">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i data-lucide="search" class="w-5 h-5 text-orange-300"></i>
            </div>
            <input type="text" id="searchInputMobile" 
                class="block w-full pl-10 pr-3 py-2 border-2 border-orange-100 rounded-full leading-5 bg-white placeholder-orange-200 focus:outline-none focus:border-orange-400 focus:ring-2 focus:ring-orange-200 transition-all duration-300 cute-font text-sm" 
                placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå...">
        </div>
    </div>

    <main class="flex-grow container mx-auto px-4 py-4 md:py-6 max-w-6xl relative">
        
        <div class="flex flex-col md:flex-row gap-6">
            
            <aside class="w-full md:w-64 flex-shrink-0 sticky top-0 md:top-24 z-30 bg-transparent pointer-events-none md:pointer-events-auto">
                <div class="pointer-events-auto">
                    <h3 class="text-lg font-bold text-orange-800 cute-font mb-3 hidden md:block px-2">
                        <i data-lucide="list-filter" class="inline w-4 h-4 mr-1"></i> ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
                    </h3>
                    
                    <div id="categoryMenu" class="flex overflow-x-auto md:flex-col gap-2 pb-2 md:pb-0 hide-scroll snap-x py-2 md:py-0 -mx-4 px-4 md:mx-0 md:px-0 bg-white/90 backdrop-blur-md md:bg-transparent shadow-sm md:shadow-none border-b md:border-none border-orange-100 md:rounded-none">
                        <div class="animate-pulse bg-white h-10 w-24 rounded-full md:w-full md:rounded-xl"></div>
                        <div class="animate-pulse bg-white h-10 w-24 rounded-full md:w-full md:rounded-xl"></div>
                        <div class="animate-pulse bg-white h-10 w-24 rounded-full md:w-full md:rounded-xl"></div>
                    </div>
                </div>
            </aside>

            <div class="flex-grow min-w-0 pt-2 md:pt-0">
                <div id="loadingState" class="text-center py-12 hidden">
                    <div class="loader mb-4"></div>
                    <p class="cute-font text-orange-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏à‡πâ‡∏≤...</p>
                </div>

                <div id="cardGrid" class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-6"></div>

                <div id="noResults" class="hidden text-center py-12">
                    <div class="bg-white p-6 rounded-3xl inline-block shadow-sm">
                        <i data-lucide="frown" class="w-12 h-12 mx-auto text-orange-300 mb-2"></i>
                        <p class="cute-font text-lg text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡πâ‡∏≤</p>
                    </div>
                </div>

                <div id="errorState" class="hidden text-center py-12">
                    <div class="bg-red-50 p-6 rounded-3xl inline-block shadow-sm border border-red-100">
                        <i data-lucide="alert-circle" class="w-12 h-12 mx-auto text-red-400 mb-2"></i>
                        <p class="cute-font text-lg text-red-500">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="chatbot-container" class="fixed bottom-6 right-6 flex flex-col items-end z-[100]">
        <div id="chatbot-window" class="w-[90vw] md:w-[380px] h-[500px] bg-white rounded-3xl shadow-2xl border border-orange-100 flex flex-col overflow-hidden mb-4">
            <div class="bg-orange-500 p-4 flex justify-between items-center text-white">
                <div class="flex items-center gap-2">
                    <i data-lucide="bot" class="w-6 h-6"></i>
                    <span class="cute-font font-bold">‡∏û‡∏µ‡πà AI ‡∏™‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠</span>
                </div>
                <button onclick="toggleChat()" class="hover:bg-orange-600 rounded-full p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-orange-50/30">
                <div class="flex flex-col items-start">
                    <div class="bg-white p-3 rounded-2xl rounded-bl-none shadow-sm text-sm chat-bubble-ai relative max-w-[85%]">
                        ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏à‡πâ‡∏≤! ‡∏°‡∏µ‡∏Ñ‡∏≥‡πÑ‡∏´‡∏ô‡πÉ‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡πÑ‡∏´‡∏ô ‡∏ñ‡∏≤‡∏°‡∏û‡∏µ‡πà AI ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞ üß°
                    </div>
                </div>
            </div>

            <div id="chat-thinking" class="hidden px-4 py-2">
                <div class="flex gap-1">
                    <div class="w-2 h-2 bg-orange-300 rounded-full thinking-dot"></div>
                    <div class="w-2 h-2 bg-orange-300 rounded-full thinking-dot" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-orange-300 rounded-full thinking-dot" style="animation-delay: 0.4s"></div>
                </div>
            </div>

            <div class="p-4 border-t border-orange-100 flex gap-2 bg-white">
                <input type="text" id="chat-input" class="flex-1 bg-orange-50 border-none rounded-2xl px-4 py-2 text-sm focus:ring-2 focus:ring-orange-300 outline-none" placeholder="‡∏ñ‡∏≤‡∏°‡∏û‡∏µ‡πà AI ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢...">
                <button id="send-chat" class="bg-orange-500 text-white p-2 rounded-xl hover:bg-orange-600 transition-colors">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <button onclick="toggleChat()" class="bg-orange-500 hover:bg-orange-600 text-white p-4 rounded-full shadow-lg transition-transform hover:scale-110 active:scale-95 flex items-center justify-center">
            <i data-lucide="message-circle" class="w-8 h-8" id="chat-icon"></i>
        </button>
    </div>

    <footer class="text-center py-6 text-orange-300 text-sm cute-font">
        <p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å üß° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</p>
    </footer>

    <div id="detailModal" class="relative z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-orange-900/30 backdrop-blur-sm transition-opacity"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0" onclick="closeModal()">
                <div class="relative transform overflow-hidden rounded-3xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg modal-content border-4 border-orange-100" onclick="event.stopPropagation()">
                    <button onclick="closeModal()" class="absolute top-4 right-4 bg-orange-100 hover:bg-orange-200 text-orange-500 rounded-full p-1 transition-colors z-20 shadow-md">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="flex flex-col items-center">
                            <div class="w-full h-64 bg-orange-50 rounded-2xl overflow-hidden mb-4 relative flex items-center justify-center border border-orange-100">
                                <img id="modalImage" src="" alt="Sign Language" class="max-w-full max-h-full object-contain">
                                <div class="absolute bottom-2 right-2 bg-white/90 px-3 py-1 rounded-full text-xs font-bold text-orange-500 shadow-sm border border-orange-100" id="modalCategory"></div>
                            </div>
                            <h3 id="modalTitle" class="text-3xl font-bold text-orange-600 cute-font mb-1 text-center"></h3>
                            <p id="modalWordEn" class="text-sm text-gray-400 font-medium mb-4 text-center"></p>
                            <div class="w-full bg-orange-50/50 rounded-xl p-4 mb-3 border border-orange-100">
                                <h4 class="text-sm font-bold text-orange-400 mb-1 cute-font flex items-center gap-1"><i data-lucide="book-open" class="w-4 h-4"></i> ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥</h4>
                                <p id="modalDesc" class="text-gray-600 text-sm leading-relaxed"></p>
                                <p id="modalDescEn" class="text-gray-400 text-xs mt-2 italic border-t border-orange-100 pt-2"></p>
                            </div>
                            <div class="w-full bg-yellow-50 rounded-xl p-3 mb-4 border border-yellow-100 flex gap-3 items-start">
                                <div class="bg-yellow-100 p-1.5 rounded-full text-yellow-500 mt-0.5 shrink-0"><i data-lucide="lightbulb" class="w-4 h-4"></i></div>
                                <div>
                                    <span class="text-xs font-bold text-yellow-600 block mb-0.5">‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≥</span>
                                    <p id="modalTip" class="text-yellow-800 text-sm"></p>
                                </div>
                            </div>
                            <div id="videoContainer" class="w-full rounded-xl overflow-hidden shadow-sm bg-black relative aspect-video hidden">
                                <iframe id="modalYoutube" class="w-full h-full absolute inset-0 z-10" src="" frameborder="0" allowfullscreen></iframe>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Data Setup & Navigation ---
        let vocabData = []; 
        let categories = ['‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'];
        let activeCategory = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        
        const cardGrid = document.getElementById('cardGrid');
        const categoryMenu = document.getElementById('categoryMenu');
        const searchInputDesktop = document.getElementById('searchInputDesktop');
        const searchInputMobile = document.getElementById('searchInputMobile');
        const loadingState = document.getElementById('loadingState');
        const modal = document.getElementById('detailModal');

        async function loadData() {
            loadingState.classList.remove('hidden');
            try {
                const response = await fetch('signs500.json');
                const rawData = await response.json();
                vocabData = rawData.map(item => ({ ...item, category: item.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' }));
                const uniqueCats = [...new Set(vocabData.map(item => item.category))].sort();
                categories = ['‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', ...uniqueCats];
                loadingState.classList.add('hidden');
                renderCategories();
                filterAndRender();
            } catch (error) {
                document.getElementById('errorState').classList.remove('hidden');
                loadingState.classList.add('hidden');
            }
        }

        function renderCategories() {
            categoryMenu.innerHTML = categories.map(cat => `
                <button onclick="setCategory('${cat}')" class="${activeCategory === cat ? 'bg-orange-500 text-white shadow-md' : 'bg-white text-gray-600 border border-orange-100'} shrink-0 snap-start px-4 py-2 rounded-full md:rounded-xl transition-all cute-font text-sm md:w-full md:text-left whitespace-nowrap">
                    ${cat}
                </button>
            `).join('');
            lucide.createIcons();
        }

        window.setCategory = (cat) => { activeCategory = cat; renderCategories(); filterAndRender(); };

        function filterAndRender() {
            const searchTerm = (searchInputDesktop.value || searchInputMobile.value || '').toLowerCase();
            const filtered = vocabData.filter(item => {
                const matchCat = activeCategory === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' || item.category === activeCategory;
                const matchSearch = item.word?.toLowerCase().includes(searchTerm) || item.word_en?.toLowerCase().includes(searchTerm);
                return matchCat && matchSearch;
            });
            renderCards(filtered);
        }

        function renderCards(items) {
            cardGrid.innerHTML = items.map(item => `
                <div onclick='openModal(${JSON.stringify(item).replace(/'/g, "&apos;")})' class="bg-white rounded-2xl shadow-sm border border-orange-100 overflow-hidden cursor-pointer card-hover transition-all flex flex-col h-full">
                    <div class="h-32 md:h-40 overflow-hidden bg-orange-50"><img src="${item.imageUrl}" class="w-full h-full object-cover"></div>
                    <div class="p-3"><h3 class="font-bold cute-font truncate">${item.word}</h3><p class="text-xs text-orange-400 truncate">${item.word_en || ''}</p></div>
                </div>
            `).join('');
            document.getElementById('noResults').classList.toggle('hidden', items.length > 0);
            lucide.createIcons();
        }

        function openModal(item) {
            document.getElementById('modalTitle').innerText = item.word;
            document.getElementById('modalWordEn').innerText = item.word_en || '';
            document.getElementById('modalCategory').innerText = item.category;
            document.getElementById('modalDesc').innerText = item.description;
            document.getElementById('modalImage').src = item.imageUrl;
            document.getElementById('modalTip').innerText = item.tip || '-';
            
            const ytFrame = document.getElementById('modalYoutube');
            if (item.youtubeUrl) {
                const id = item.youtubeUrl.match(/(?:v=|\/embed\/|youtu\.be\/)([^&?#]+)/)?.[1];
                ytFrame.src = id ? `https://www.youtube.com/embed/${id}` : "";
                document.getElementById('videoContainer').classList.toggle('hidden', !id);
            } else {
                document.getElementById('videoContainer').classList.add('hidden');
            }
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() { modal.classList.add('hidden'); document.getElementById('modalYoutube').src = ""; document.body.style.overflow = 'auto'; }

        // --- 2. Chatbot Logic & Backend ---
        const BACKEND_URL = 'https://kodmai2025-github-io.vercel.app/api/chat'; 
        let chatHistory = [
            { role: "user", parts: [{ text: "System Instruction: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ '‡∏û‡∏µ‡πà AI ‡∏™‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠' ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏à‡∏î‡∏µ ‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡∏°‡∏µ‡∏´‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á '‡∏à‡πâ‡∏≤' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏ô‡∏∞‡∏à‡πä‡∏∞' ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠‡πÑ‡∏ó‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏≤‡∏Å‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠‡∏ô‡∏∞" }] },
            { role: "model", parts: [{ text: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏à‡πâ‡∏≤! ‡∏û‡∏µ‡πà AI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏ô‡πâ‡∏≠‡∏á‡πÜ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏°‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞‡∏à‡πä‡∏∞ üß°" }] }
        ];

        function toggleChat() {
            const win = document.getElementById('chatbot-window');
            const icon = document.getElementById('chat-icon');
            const isActive = win.classList.toggle('active');
            icon.setAttribute('data-lucide', isActive ? 'x' : 'message-circle');
            lucide.createIcons();
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            appendBubble(text, 'user');
            input.value = '';
            document.getElementById('chat-thinking').classList.remove('hidden');

            chatHistory.push({ role: "user", parts: [{ text: text }] });

            try {
                const res = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ history: chatHistory })
                });
                const data = await res.json();
                const reply = data.reply || "‡∏û‡∏µ‡πà AI ‡∏á‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏à‡πâ‡∏≤ ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞";
                
                appendBubble(reply, 'ai');
                chatHistory.push({ role: "model", parts: [{ text: reply }] });
            } catch (err) {
                appendBubble("‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏ó‡∏µ‡∏à‡πâ‡∏≤ ‡∏û‡∏µ‡πà AI ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß", 'ai');
            } finally {
                document.getElementById('chat-thinking').classList.add('hidden');
            }
        }

        function appendBubble(text, side) {
            const msgDiv = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `flex flex-col ${side === 'user' ? 'items-end' : 'items-start'}`;
            const formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            
            div.innerHTML = `
                <div class="${side === 'user' ? 'bg-orange-500 text-white rounded-br-none chat-bubble-user' : 'bg-white text-gray-800 rounded-bl-none chat-bubble-ai'} p-3 rounded-2xl shadow-sm text-sm relative max-w-[85%]">
                    ${formatted}
                </div>
            `;
            msgDiv.appendChild(div);
            msgDiv.scrollTop = msgDiv.scrollHeight;
        }

        document.getElementById('send-chat').onclick = sendMessage;
        document.getElementById('chat-input').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
        searchInputDesktop.oninput = filterAndRender;
        searchInputMobile.oninput = filterAndRender;

        loadData();
        lucide.createIcons();
    </script>
</body>
</html>
